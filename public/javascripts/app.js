(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
'use strict';

exports.__esModule = true;

var _canvas = require('./canvas');

var _ga = require('./ga');

var _utils = require('./utils');

var image_path = 'images/Yosemite_Falls_small.jpg';
var poolSize = 6;

var proto = {

    start: function start() {
        this.img = new Image();
        this.img.onload = this.imageLoaded.bind(this);
        this.img.src = image_path;
        this.pool = [];
    },

    imageLoaded: function imageLoaded() {
        this.targetImageCanvas = _canvas.Canvas.create(this.img.width, this.img.height);
        this.targetImageCanvas.setImage(this.img);
        this.targetImageCanvas.addTo(this.targetContainer);
        this.currentBestCanvas = _canvas.Canvas.create(this.img.width, this.img.height);
        this.currentBestCanvas.addTo(this.targetContainer);
        this.ga = _ga.GA.create(this.targetImageCanvas);
        this.fitnessFunction = _utils.Utils.imageDifference.bind(null, this.targetImageCanvas);

        var table = document.createElement('table');
        var row = undefined,
            col = undefined;

        for (var i = 0; i < poolSize; i++) {
            if (i % 2 === 0) {
                row = document.createElement('tr');
                table.appendChild(row);
            }

            this.pool[i] = _canvas.Canvas.createRandom(this.img.width, this.img.height);

            col = document.createElement('td');
            this.pool[i].addTo(col);
            row.appendChild(col);
        }

        this.poolContainer.appendChild(table);

        this.run();
    },

    run: function run() {
        this.step();
        // setTimeout(this.run.bind(this), 100);
    },

    step: function step() {
        this.calculatePoolFitness();
        this.setBest();
    },

    calculatePoolFitness: function calculatePoolFitness() {
        var _this = this;

        this.pool.forEach(function (genome) {
            genome.fitness = _this.fitnessFunction(genome);
        });
    },

    setBest: function setBest() {
        var best = _utils.Utils.minBy(function (g) {
            return g.fitness;
        }, this.pool);
        this.currentBestCanvas.setImageData(best.getImageData());
    }
};

var App = {
    create: function create(targetContainer, poolContainer) {
        return Object.assign(Object.create(proto), { targetContainer: targetContainer,
            poolContainer: poolContainer });
    }
};

exports.App = App;

},{"./canvas":2,"./ga":3,"./utils":5}],2:[function(require,module,exports){
'use strict';

exports.__esModule = true;
var proto = {

    init: function init() {
        this.domCanvas = document.createElement('canvas');
        this.domCanvas.width = this.width;
        this.domCanvas.height = this.height;
        this.ctx = this.domCanvas.getContext('2d');
    },

    setImage: function setImage(image) {
        this.ctx.drawImage(image, 0, 0);
    },

    addTo: function addTo(domContainer) {
        domContainer.appendChild(this.domCanvas);
    },

    getImageData: function getImageData() {
        return this.ctx.getImageData(0, 0, this.width, this.height);
    },

    createImageData: function createImageData() {
        return this.ctx.createImageData(this.width, this.height);
    },

    setImageData: function setImageData(imageData) {
        this.ctx.putImageData(imageData, 0, 0);
    }
};

var Canvas = {
    create: function create(width, height) {
        var canvas = Object.create(proto);
        canvas.width = width;
        canvas.height = height;
        canvas.init();

        return canvas;
    },

    createRandom: function createRandom(width, height) {
        var canvas = Canvas.create(width, height);

        var img = canvas.createImageData(),
            data = img.data;

        for (var i = 0; i + 3 < data.length; i += 4) {
            data[i] = Math.random() * 255; // r
            data[i + 1] = Math.random() * 255; // g
            data[i + 2] = Math.random() * 255; // b
            data[i + 3] = 255; // a
        }

        canvas.setImageData(img);

        return canvas;
    }
};

exports.Canvas = Canvas;

},{}],3:[function(require,module,exports){
"use strict";

exports.__esModule = true;

var proto = {

    selectParents: function selectParents(pool) {
        return pool;
    },

    breed: function breed(parent1, parent2) {
        return parent1.getImageData();
    }
};

var GA = {
    create: function create(target) {
        return Object.create(proto);
    }
};

exports.GA = GA;

},{}],4:[function(require,module,exports){
'use strict';

var _app = require('./app');

var poolContainer = document.getElementById('gene-pool'),
    targetContainer = document.getElementById('target'),
    app = _app.App.create(targetContainer, poolContainer);
app.start();

},{"./app":1}],5:[function(require,module,exports){
"use strict";

exports.__esModule = true;
var Utils = {

    sample: function sample(array) {
        var index = Math.random() * array.length | 0;
        return array[index];
    },

    minBy: function minBy(transform, items) {
        return items.map(function (i) {
            return { item: i, value: transform(i) };
        }).reduce(function (best, current) {
            return current.value < best.value ? current : best;
        }).item;
    },

    imageDifference: function imageDifference(image1, image2) {
        var data1 = image1.getImageData().data,
            data2 = image2.getImageData().data;
        var differences = 0;

        for (var i = 0; i < data1.length; i++) {
            if (data1[i] !== data2[i]) {
                differences += 1;
            }
        }

        return differences;
    }
};

exports.Utils = Utils;

},{}]},{},[1,2,3,4,5])
//# sourceMappingURL=data:application/json;charset:utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9ncnVudC1icm93c2VyaWZ5L25vZGVfbW9kdWxlcy9icm93c2VyaWZ5L25vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCIvaG9tZS9hbmRyZS9jb2RlL2dhL2FwcC9hcHAuanMiLCIvaG9tZS9hbmRyZS9jb2RlL2dhL2FwcC9jYW52YXMuanMiLCIvaG9tZS9hbmRyZS9jb2RlL2dhL2FwcC9nYS5qcyIsIi9ob21lL2FuZHJlL2NvZGUvZ2EvYXBwL21haW4uanMiLCIvaG9tZS9hbmRyZS9jb2RlL2dhL2FwcC91dGlscy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7c0JDQXFCLFVBQVU7O2tCQUNkLE1BQU07O3FCQUNILFNBQVM7O0FBRTdCLElBQU0sVUFBVSxHQUFHLGlDQUFpQyxDQUFDO0FBQ3JELElBQU0sUUFBUSxHQUFHLENBQUMsQ0FBQzs7QUFFbkIsSUFBTSxLQUFLLEdBQUc7O0FBRVYsU0FBSyxFQUFBLGlCQUFHO0FBQ0osWUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFDO0FBQ3ZCLFlBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQzlDLFlBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLFVBQVUsQ0FBQztBQUMxQixZQUFJLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztLQUNsQjs7QUFFRCxlQUFXLEVBQUEsdUJBQUc7QUFDVixZQUFJLENBQUMsaUJBQWlCLEdBQUcsZUFBTyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUN4RSxZQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUMxQyxZQUFJLENBQUMsaUJBQWlCLENBQUMs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QUcsSUFBSTtTQUNoRCxDQUFDLENBQUMsSUFBSSxDQUFDO0tBQ1g7O0FBRUQsbUJBQWUsRUFBQSx5QkFBQyxNQUFNLEVBQUUsTUFBTSxFQUFFO0FBQzVCLFlBQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxZQUFZLEVBQUUsQ0FBQyxJQUFJO1lBQ3BDLEtBQUssR0FBRyxNQUFNLENBQUMsWUFBWSxFQUFFLENBQUMsSUFBSSxDQUFDO0FBQ3ZDLFlBQUksV0FBVyxHQUFHLENBQUMsQ0FBQzs7QUFFcEIsYUFBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDbkMsZ0JBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRTtBQUN2QiwyQkFBVyxJQUFJLENBQUMsQ0FBQzthQUNwQjtTQUNKOztBQUVELGVBQU8sV0FBVyxDQUFDO0tBQ3RCO0NBQ0osQ0FBQzs7UUFHTSxLQUFLLEdBQUwsS0FBSyIsImZpbGUiOiJnZW5lcmF0ZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt2YXIgZj1uZXcgRXJyb3IoXCJDYW5ub3QgZmluZCBtb2R1bGUgJ1wiK28rXCInXCIpO3Rocm93IGYuY29kZT1cIk1PRFVMRV9OT1RfRk9VTkRcIixmfXZhciBsPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChsLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGwsbC5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtmb3IodmFyIG89MDtvPHIubGVuZ3RoO28rKylzKHJbb10pO3JldHVybiBzfSkiLCJpbXBvcnQge0NhbnZhc30gZnJvbSAnLi9jYW52YXMnO1xuaW1wb3J0IHtHQX0gZnJvbSAnLi9nYSc7XG5pbXBvcnQge1V0aWxzfSBmcm9tICcuL3V0aWxzJztcblxuY29uc3QgaW1hZ2VfcGF0aCA9ICdpbWFnZXMvWW9zZW1pdGVfRmFsbHNfc21hbGwuanBnJztcbmNvbnN0IHBvb2xTaXplID0gNjtcblxuY29uc3QgcHJvdG8gPSB7XG5cbiAgICBzdGFydCgpIHtcbiAgICAgICAgdGhpcy5pbWcgPSBuZXcgSW1hZ2UoKTtcbiAgICAgICAgdGhpcy5pbWcub25sb2FkID0gdGhpcy5pbWFnZUxvYWRlZC5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLmltZy5zcmMgPSBpbWFnZV9wYXRoO1xuICAgICAgICB0aGlzLnBvb2wgPSBbXTtcbiAgICB9LFxuXG4gICAgaW1hZ2VMb2FkZWQoKSB7XG4gICAgICAgIHRoaXMudGFyZ2V0SW1hZ2VDYW52YXMgPSBDYW52YXMuY3JlYXRlKHRoaXMuaW1nLndpZHRoLCB0aGlzLmltZy5oZWlnaHQpO1xuICAgICAgICB0aGlzLnRhcmdldEltYWdlQ2FudmFzLnNldEltYWdlKHRoaXMuaW1nKTtcbiAgICAgICAgdGhpcy50YXJnZXRJbWFnZUNhbnZhcy5hZGRUbyh0aGlzLnRhcmdldENvbnRhaW5lcik7XG4gICAgICAgIHRoaXMuY3VycmVudEJlc3RDYW52YXMgPSBDYW52YXMuY3JlYXRlKHRoaXMuaW1nLndpZHRoLCB0aGlzLmltZy5oZWlnaHQpO1xuICAgICAgICB0aGlzLmN1cnJlbnRCZXN0Q2FudmFzLmFkZFRvKHRoaXMudGFyZ2V0Q29udGFpbmVyKTtcbiAgICAgICAgdGhpcy5nYSA9IEdBLmNyZWF0ZSh0aGlzLnRhcmdldEltYWdlQ2FudmFzKTtcbiAgICAgICAgdGhpcy5maXRuZXNzRnVuY3Rpb24gPSBVdGlscy5pbWFnZURpZmZlcmVuY2UuYmluZChudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0SW1hZ2VDYW52YXMpO1xuXG4gICAgICAgIGNvbnN0IHRhYmxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGFibGUnKTtcbiAgICAgICAgbGV0IHJvdywgY29sO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9vbFNpemU7IGkrKykge1xuICAgICAgICAgICAgaWYgKGkgJSAyID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcm93ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndHInKTtcbiAgICAgICAgICAgICAgICB0YWJsZS5hcHBlbmRDaGlsZChyb3cpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLnBvb2xbaV0gPSBDYW52YXMuY3JlYXRlUmFuZG9tKHRoaXMuaW1nLndpZHRoLCB0aGlzLmltZy5oZWlnaHQpO1xuXG4gICAgICAgICAgICBjb2wgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZCcpO1xuICAgICAgICAgICAgdGhpcy5wb29sW2ldLmFkZFRvKGNvbCk7XG4gICAgICAgICAgICByb3cuYXBwZW5kQ2hpbGQoY29sKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucG9vbENvbnRhaW5lci5hcHBlbmRDaGlsZCh0YWJsZSk7XG5cbiAgICAgICAgdGhpcy5ydW4oKTtcbiAgICB9LFxuXG4gICAgcnVuKCkge1xuICAgICAgICB0aGlzLnN0ZXAoKTtcbiAgICAgICAgLy8gc2V0VGltZW91dCh0aGlzLnJ1bi5iaW5kKHRoaXMpLCAxMDApO1xuICAgIH0sXG5cbiAgICBzdGVwKCkge1xuICAgICAgICB0aGlzLmNhbGN1bGF0ZVBvb2xGaXRuZXNzKCk7XG4gICAgICAgIHRoaXMuc2V0QmVzdCgpO1xuICAgIH0sXG5cbiAgICBjYWxjdWxhdGVQb29sRml0bmVzcygpIHtcbiAgICAgICAgdGhpcy5wb29sLmZvckVhY2goZ2Vub21lID0+IHtcbiAgICAgICAgICAgIGdlbm9tZS5maXRuZXNzID0gdGhpcy5maXRuZXNzRnVuY3Rpb24oZ2Vub21lKTtcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIHNldEJlc3QoKSB7XG4gICAgICAgIGNvbnN0IGJlc3QgPSBVdGlscy5taW5CeShnID0+IGcuZml0bmVzcywgdGhpcy5wb29sKTtcbiAgICAgICAgdGhpcy5jdXJyZW50QmVzdENhbnZhcy5zZXRJbWFnZURhdGEoYmVzdC5nZXRJbWFnZURhdGEoKSk7XG4gICAgfVxufTtcblxuY29uc3QgQXBwID0ge1xuICAgIGNyZWF0ZSh0YXJnZXRDb250YWluZXIsIHBvb2xDb250YWluZXIpIHtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oT2JqZWN0LmNyZWF0ZShwcm90byksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge3RhcmdldENvbnRhaW5lcjogdGFyZ2V0Q29udGFpbmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb29sQ29udGFpbmVyOiBwb29sQ29udGFpbmVyfSk7XG4gICAgfVxufTtcblxuXG5leHBvcnQge0FwcH07XG4iLCJjb25zdCBwcm90byA9IHtcblxuICAgIGluaXQoKSB7XG4gICAgICAgIHRoaXMuZG9tQ2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XG4gICAgICAgIHRoaXMuZG9tQ2FudmFzLndpZHRoID0gdGhpcy53aWR0aDtcbiAgICAgICAgdGhpcy5kb21DYW52YXMuaGVpZ2h0ID0gdGhpcy5oZWlnaHQ7XG4gICAgICAgIHRoaXMuY3R4ID0gdGhpcy5kb21DYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcbiAgICB9LFxuXG4gICAgc2V0SW1hZ2UoaW1hZ2UpIHtcbiAgICAgICAgdGhpcy5jdHguZHJhd0ltYWdlKGltYWdlLCAwLCAwKTtcbiAgICB9LFxuXG4gICAgYWRkVG8oZG9tQ29udGFpbmVyKSB7XG4gICAgICAgIGRvbUNvbnRhaW5lci5hcHBlbmRDaGlsZCh0aGlzLmRvbUNhbnZhcyk7XG4gICAgfSxcblxuICAgIGdldEltYWdlRGF0YSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3R4LmdldEltYWdlRGF0YSgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7XG4gICAgfSxcblxuICAgIGNyZWF0ZUltYWdlRGF0YSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3R4LmNyZWF0ZUltYWdlRGF0YSh0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7XG4gICAgfSxcblxuICAgIHNldEltYWdlRGF0YShpbWFnZURhdGEpIHtcbiAgICAgICAgdGhpcy5jdHgucHV0SW1hZ2VEYXRhKGltYWdlRGF0YSwgMCwgMCk7XG4gICAgfVxufTtcblxuY29uc3QgQ2FudmFzID0ge1xuICAgIGNyZWF0ZSh3aWR0aCwgaGVpZ2h0KSB7XG4gICAgICAgIHZhciBjYW52YXMgPSBPYmplY3QuY3JlYXRlKHByb3RvKTtcbiAgICAgICAgY2FudmFzLndpZHRoID0gd2lkdGg7XG4gICAgICAgIGNhbnZhcy5oZWlnaHQgPSBoZWlnaHQ7XG4gICAgICAgIGNhbnZhcy5pbml0KCk7XG5cbiAgICAgICAgcmV0dXJuIGNhbnZhcztcbiAgICB9LFxuXG4gICAgY3JlYXRlUmFuZG9tKHdpZHRoLCBoZWlnaHQpIHtcbiAgICAgICAgdmFyIGNhbnZhcyA9IENhbnZhcy5jcmVhdGUod2lkdGgsIGhlaWdodCk7XG5cbiAgICAgICAgdmFyIGltZyA9IGNhbnZhcy5jcmVhdGVJbWFnZURhdGEoKSxcbiAgICAgICAgICAgIGRhdGEgPSBpbWcuZGF0YTtcblxuICAgICAgICBmb3IgKHZhciBpID0gMDsgKGkrMykgPCBkYXRhLmxlbmd0aDsgaSArPSA0KSB7XG4gICAgICAgICAgICBkYXRhW2ldID0gTWF0aC5yYW5kb20oKSAqIDI1NTsgLy8gclxuICAgICAgICAgICAgZGF0YVtpKzFdID0gTWF0aC5yYW5kb20oKSAqIDI1NTsgLy8gZ1xuICAgICAgICAgICAgZGF0YVtpKzJdID0gTWF0aC5yYW5kb20oKSAqIDI1NTsgLy8gYlxuICAgICAgICAgICAgZGF0YVtpKzNdID0gMjU1OyAvLyBhXG4gICAgICAgIH1cblxuICAgICAgICBjYW52YXMuc2V0SW1hZ2VEYXRhKGltZyk7XG5cbiAgICAgICAgcmV0dXJuIGNhbnZhcztcbiAgICB9XG59XG5cblxuZXhwb3J0IHtDYW52YXN9O1xuIiwiXG5jb25zdCBwcm90byA9IHtcblxuICAgIHNlbGVjdFBhcmVudHMocG9vbCkge1xuICAgICAgICByZXR1cm4gcG9vbDtcbiAgICB9LFxuXG4gICAgYnJlZWQocGFyZW50MSwgcGFyZW50Mikge1xuICAgICAgICByZXR1cm4gcGFyZW50MS5nZXRJbWFnZURhdGEoKTtcbiAgICB9XG59O1xuXG5jb25zdCBHQSA9IHtcbiAgICBjcmVhdGUodGFyZ2V0KSB7XG4gICAgICAgIHJldHVybiBPYmplY3QuY3JlYXRlKHByb3RvKTtcbiAgICB9XG59O1xuXG5cbmV4cG9ydCB7R0F9O1xuIiwiaW1wb3J0IHtBcHB9IGZyb20gJy4vYXBwJztcblxuY29uc3QgcG9vbENvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnZW5lLXBvb2wnKSxcbiAgICAgIHRhcmdldENvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0YXJnZXQnKSxcbiAgICAgIGFwcCA9IEFwcC5jcmVhdGUodGFyZ2V0Q29udGFpbmVyLCBwb29sQ29udGFpbmVyKTtcbmFwcC5zdGFydCgpO1xuIiwiY29uc3QgVXRpbHMgPSB7XG5cbiAgICBzYW1wbGUoYXJyYXkpIHtcbiAgICAgICAgY29uc3QgaW5kZXggPSBNYXRoLnJhbmRvbSgpICogYXJyYXkubGVuZ3RoIHwgMDtcbiAgICAgICAgcmV0dXJuIGFycmF5W2luZGV4XTtcbiAgICB9LFxuXG4gICAgbWluQnkodHJhbnNmb3JtLCBpdGVtcykge1xuICAgICAgICByZXR1cm4gaXRlbXMubWFwKGkgPT4gKFxuICAgICAgICAgICAge2l0ZW06IGksIHZhbHVlOiB0cmFuc2Zvcm0oaSl9XG4gICAgICAgICkpLnJlZHVjZSgoYmVzdCwgY3VycmVudCkgPT4gKFxuICAgICAgICAgICAgKGN1cnJlbnQudmFsdWUgPCBiZXN0LnZhbHVlKSA/IGN1cnJlbnQgOiBiZXN0XG4gICAgICAgICkpLml0ZW07XG4gICAgfSxcblxuICAgIGltYWdlRGlmZmVyZW5jZShpbWFnZTEsIGltYWdlMikge1xuICAgICAgICBjb25zdCBkYXRhMSA9IGltYWdlMS5nZXRJbWFnZURhdGEoKS5kYXRhLFxuICAgICAgICAgICAgZGF0YTIgPSBpbWFnZTIuZ2V0SW1hZ2VEYXRhKCkuZGF0YTtcbiAgICAgICAgbGV0IGRpZmZlcmVuY2VzID0gMDtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGExLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBpZiAoZGF0YTFbaV0gIT09IGRhdGEyW2ldKSB7XG4gICAgICAgICAgICAgICAgZGlmZmVyZW5jZXMgKz0gMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBkaWZmZXJlbmNlcztcbiAgICB9XG59O1xuXG5cbmV4cG9ydCB7VXRpbHN9O1xuIl19
