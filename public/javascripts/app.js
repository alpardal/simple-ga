(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
'use strict';

exports.__esModule = true;

var _ga = require('./ga');

var _utils = require('./utils');

var proto = {

    start: function start() {
        var _this = this;

        this.targetImage = this.view.getTargetImage();
        this.fitnessFunction = function (i) {
            return 1 / (1 + _utils.Utils.imageDifference(_this.targetImage, i));
        };
        this.setPopulation(_utils.Utils.fillArray(App.POPULATION_SIZE, function () {
            return _utils.Utils.fillArray(_this.targetImage.length, _utils.Utils.randInt.bind(null, 256));
        }));

        this.render();
        this.run();
    },

    run: function run() {
        this.step();
        requestAnimationFrame(this.run.bind(this));
    },

    step: function step() {
        this.update();
        this.render();
    },

    update: function update() {
        generations++;
        this.setPopulation(_ga.GA.nextGeneration(this.population));
    },

    render: function render() {
        if (generations % 10 === 0) {
            console.log(generations + ' geracoes, melhor fitness: ' + this.best.fitness);
            this.view.render(this);
        }
    },

    setPopulation: function setPopulation(population) {
        var _this2 = this;

        this.population = population;
        this.population.forEach(function (p) {
            return p.fitness = _this2.fitnessFunction(p);
        });
        this.best = _utils.Utils.maxBy(function (p) {
            return p.fitness;
        }, this.population);
    }
};

var generations = 0;

var App = {
    create: function create(view) {
        return Object.assign(Object.create(proto), { view: view });
    },

    POPULATION_SIZE: 200
};

exports.App = App;

},{"./ga":3,"./utils":5}],2:[function(require,module,exports){
'use strict';

exports.__esModule = true;
var proto = {

    init: function init() {
        this.domCanvas = document.createElement('canvas');
        this.domCanvas.width = this.width;
        this.domCanvas.height = this.height;
        this.ctx = this.domCanvas.getContext('2d');
    },

    setImage: function setImage(image) {
        this.ctx.drawImage(image, 0, 0);
    },

    addTo: function addTo(domContainer) {
        domContainer.appendChild(this.domCanvas);
    },

    getYuvImage: function getYuvImage() {
        var imageData = this.ctx.getImageData(0, 0, this.width, this.height).data,
            yuvData = [];

        for (var i = 0; i < imageData.length; i += 4) {
            yuvData.push(imageData[i]);
        }

        return yuvData;
    },

    setYuvImage: function setYuvImage(yuvImage) {
        var imageData = this.ctx.createImageData(this.width, this.height),
            data = imageData.data;

        yuvImage.forEach(function (c, i) {
            var dataIndex = i * 4;

            data[dataIndex] = c;
            data[dataIndex + 1] = c;
            data[dataIndex + 2] = c;
            data[dataIndex + 3] = 255; // alpha
        });

        this.ctx.putImageData(imageData, 0, 0);
    }
};

var Canvas = {
    create: function create(width, height) {
        var canvas = Object.create(proto);
        canvas.width = width;
        canvas.height = height;
        canvas.init();

        return canvas;
    }
};

exports.Canvas = Canvas;

},{}],3:[function(require,module,exports){
'use strict';

exports.__esModule = true;

var _utils = require('./utils');

var CONSERVE_RATIO = 0.1;

var GA = {

    nextGeneration: function nextGeneration(population) {
        var _this = this;

        var preserve = CONSERVE_RATIO * population.length,
            sortedByFitness = population.sort(function (p1, p2) {
            return p2.fitness - p1.fitness;
        }),
            toPreserve = sortedByFitness.slice(0, preserve + 1);

        population.totalFitness = population.reduce(function (sum, p) {
            return sum + p.fitness;
        }, 0);
        population.probabilities = population.map(function (p) {
            return p.fitness / population.totalFitness;
        });

        return _utils.Utils.fillArray(population.length - toPreserve.length, function () {
            var p1 = _this.selectParent(population),
                p2 = p1;
            while (p2 === p1) {
                p2 = _this.selectParent(population);
            }

            return _this.breed(p1, p2);
        }).concat(toPreserve);
    },

    selectParent: function selectParent(population) {
        var parentIndex = _utils.Utils.indexByProbabilities(population.probabilities);

        return population[parentIndex];
    },

    breed: function breed(parent1, parent2) {
        if (Math.random() < 0.75) {

            var child = [];
            // uniform crosssover:
            for (var i = 0; i < parent1.length; i++) {
                if (Math.random() < 0.5) {
                    child.push(parent1[i]);
                } else {
                    child.push(parent2[i]);
                }
            }

            return child;
        } else {
            return mutate(parent1);
        }
    },

    MUTATION_PROB: 0.005
};

function mutate(genome) {
    var mutated = [];

    for (var i = 0; i < genome.length; i++) {
        if (Math.random() < GA.MUTATION_PROB) {
            mutated.push(_utils.Utils.randInt(256));
        } else {
            mutated.push(genome[i]);
        }
    }

    return mutated;
}

exports.GA = GA;

},{"./utils":5}],4:[function(require,module,exports){
'use strict';

var _view = require('./view');

var _app = require('./app');

var populationContainer = document.getElementById('population'),
    targetContainer = document.getElementById('target'),
    view = _view.View.create(targetContainer, populationContainer);

view.load(function () {
      return _app.App.create(view).start();
});

},{"./app":1,"./view":6}],5:[function(require,module,exports){
"use strict";

exports.__esModule = true;

var Utils = {

    randInt: function randInt(max) {
        return Math.floor(Math.random() * max);
    },

    sample: function sample(array) {
        var index = Math.random() * array.length | 0;
        return array[index];
    },

    fillArray: function fillArray(size, generator) {
        var array = [];

        for (var i = 0; i < size; i++) {
            array.push(generator(i));
        }

        return array;
    },

    maxBy: function maxBy(transform, items) {
        return items.map(function (i) {
            return { item: i, value: transform(i) };
        }).reduce(function (best, current) {
            return current.value > best.value ? current : best;
        }).item;
    },

    imageDifference: function imageDifference(image1, image2) {
        var score = 0;

        for (var i = 0; i < image1.length; i++) {
            score += Math.pow(image1[i] - image2[i], 2);
        }

        return score;
    },

    indexByProbabilities: function indexByProbabilities(probs) {
        var prob = Math.random();
        var accu = probs[0],
            i = 0;

        while (accu < prob) {
            accu += probs[++i];
        }

        return i;
    }
};

exports.Utils = Utils;

},{}],6:[function(require,module,exports){
'use strict';

exports.__esModule = true;

var _canvas = require('./canvas');

var _app = require('./app');

var image_path = 'images/smiley_small.jpg';
var NUMBER_OF_CANVASES = 8;

var proto = {

    load: function load(callback) {
        this.img = new Image();
        this.img.onload = this.loaded.bind(this);
        this.finishedLoadingCallback = callback;
        this.img.src = image_path;
    },

    render: function render(app) {
        this.populationCanvases.forEach(function (c, i) {
            return c.setYuvImage(app.population[i]);
        });
        this.currentBestCanvas.setYuvImage(app.best);
    },

    loaded: function loaded() {
        this.targetImageCanvas = _canvas.Canvas.create(this.img.width, this.img.height);
        this.targetImageCanvas.setImage(this.img);
        this.targetImageCanvas.addTo(this.targetContainer);

        this.currentBestCanvas = _canvas.Canvas.create(this.img.width, this.img.height);
        this.currentBestCanvas.addTo(this.targetContainer);

        this.populationCanvases = [];

        var table = document.createElement('table');
        var row = undefined,
            col = undefined;

        for (var i = 0; i < NUMBER_OF_CANVASES; i++) {
            if (i % 2 === 0) {
                row = document.createElement('tr');
                table.appendChild(row);
            }

            this.populationCanvases[i] = _canvas.Canvas.create(this.img.width, this.img.height);

            col = document.createElement('td');
            this.populationCanvases[i].addTo(col);
            row.appendChild(col);
        }

        this.populationContainer.appendChild(table);

        this.finishedLoadingCallback();
    },

    getTargetImage: function getTargetImage() {
        return this.targetImageCanvas.getYuvImage();
    }
};

var View = {
    create: function create(targetContainer, populationContainer) {
        var view = Object.assign(Object.create(proto), { targetContainer: targetContainer,
            populationContainer: populationContainer });
        return view;
    }
};

exports.View = View;

},{"./app":1,"./canvas":2}]},{},[1,2,3,4,5,6])
//# sourceMappingURL=data:application/json;charset:utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9ncnVudC1icm93c2VyaWZ5L25vZGVfbW9kdWxlcy9icm93c2VyaWZ5L25vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCIvaG9tZS9hbmRyZS9jb2RlL2dhL2FwcC9hcHAuanMiLCIvaG9tZS9hbmRyZS9jb2RlL2dhL2FwcC9jYW52YXMuanMiLCIvaG9tZS9hbmRyZS9jb2RlL2dhL2FwcC9nYS5qcyIsIi9ob21lL2FuZHJlL2NvZGUvZ2EvYXBwL21haW4uanMiLCIvaG9tZS9hbmRyZS9jb2RlL2dhL2FwcC91dGlscy5qcyIsIi9ob21lL2FuZHJlL2NvZGUvZ2EvYXBwL3ZpZXcuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7O2tCQ0FpQixNQUFNOztxQkFDSCxTQUFTOztBQUU3QixJQUFNLEtBQUssR0FBRzs7QUFFVixTQUFLLEVBQUEsaUJBQUc7OztBQUNKLFlBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztBQUM5QyxZQUFJLENBQUMsZUFBZSxHQUFHLFVBQUMsQ0FBQzttQkFBTSxDQUFDLElBQUUsQ0FBQyxHQUFDLGFBQU0sZUFBZSxDQUFDLE1BQUssV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFBLEFBQUM7U0FBQyxDQUFDO0FBQ2pGLFlBQUksQ0FBQyxhQUFhLENBQUMsYUFBTSxTQUFTLENBQUMsR0FBRyxDQUFDLGVBQWUsRUFDcEQ7bUJBQUssYUFBTSxTQUFTLENBQUMsTUFBSyxXQUFXLENBQUMsTUFBTSxFQUFFLGFBQU0sT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7U0FBQSxDQUFDLENBQUMsQ0FBQzs7QUFFakYsWUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBQ2QsWUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0tBQ2Q7O0FBRUQsT0FBRyxFQUFBLGVBQUc7QUFDRixZQUFJLENBQUMsSUFBSSxFQUFFLENB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LENBQUMsaUJBQWlCLENBQUMsV0FBVyxFQUFFLENBQUM7S0FDL0M7Q0FDSixDQUFDOztBQUVGLElBQU0sSUFBSSxHQUFHO0FBQ1QsVUFBTSxFQUFBLGdCQUFDLGVBQWUsRUFBRSxtQkFBbUIsRUFBRTtBQUN6QyxZQUFNLElBQUksR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQzFCLEVBQUMsZUFBZSxFQUFFLGVBQWU7QUFDaEMsK0JBQW1CLEVBQUUsbUJBQW1CLEVBQUMsQ0FBQyxDQUFDO0FBQ2pFLGVBQU8sSUFBSSxDQUFDO0tBQ2Y7Q0FDSixDQUFDOztRQUdNLElBQUksR0FBSixJQUFJIiwiZmlsZSI6ImdlbmVyYXRlZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24gZSh0LG4scil7ZnVuY3Rpb24gcyhvLHUpe2lmKCFuW29dKXtpZighdFtvXSl7dmFyIGE9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtpZighdSYmYSlyZXR1cm4gYShvLCEwKTtpZihpKXJldHVybiBpKG8sITApO3ZhciBmPW5ldyBFcnJvcihcIkNhbm5vdCBmaW5kIG1vZHVsZSAnXCIrbytcIidcIik7dGhyb3cgZi5jb2RlPVwiTU9EVUxFX05PVF9GT1VORFwiLGZ9dmFyIGw9bltvXT17ZXhwb3J0czp7fX07dFtvXVswXS5jYWxsKGwuZXhwb3J0cyxmdW5jdGlvbihlKXt2YXIgbj10W29dWzFdW2VdO3JldHVybiBzKG4/bjplKX0sbCxsLmV4cG9ydHMsZSx0LG4scil9cmV0dXJuIG5bb10uZXhwb3J0c312YXIgaT10eXBlb2YgcmVxdWlyZT09XCJmdW5jdGlvblwiJiZyZXF1aXJlO2Zvcih2YXIgbz0wO288ci5sZW5ndGg7bysrKXMocltvXSk7cmV0dXJuIHN9KSIsImltcG9ydCB7R0F9IGZyb20gJy4vZ2EnO1xuaW1wb3J0IHtVdGlsc30gZnJvbSAnLi91dGlscyc7XG5cbmNvbnN0IHByb3RvID0ge1xuXG4gICAgc3RhcnQoKSB7XG4gICAgICAgIHRoaXMudGFyZ2V0SW1hZ2UgPSB0aGlzLnZpZXcuZ2V0VGFyZ2V0SW1hZ2UoKTtcbiAgICAgICAgdGhpcy5maXRuZXNzRnVuY3Rpb24gPSAoaSkgPT4gKDEvKDErVXRpbHMuaW1hZ2VEaWZmZXJlbmNlKHRoaXMudGFyZ2V0SW1hZ2UsIGkpKSk7XG4gICAgICAgIHRoaXMuc2V0UG9wdWxhdGlvbihVdGlscy5maWxsQXJyYXkoQXBwLlBPUFVMQVRJT05fU0laRSxcbiAgICAgICAgICAoKT0+IFV0aWxzLmZpbGxBcnJheSh0aGlzLnRhcmdldEltYWdlLmxlbmd0aCwgVXRpbHMucmFuZEludC5iaW5kKG51bGwsIDI1NikpKSk7XG5cbiAgICAgICAgdGhpcy5yZW5kZXIoKTtcbiAgICAgICAgdGhpcy5ydW4oKTtcbiAgICB9LFxuXG4gICAgcnVuKCkge1xuICAgICAgICB0aGlzLnN0ZXAoKTtcbiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMucnVuLmJpbmQodGhpcykpO1xuICAgIH0sXG5cbiAgICBzdGVwKCkge1xuICAgICAgICB0aGlzLnVwZGF0ZSgpO1xuICAgICAgICB0aGlzLnJlbmRlcigpO1xuICAgIH0sXG5cbiAgICB1cGRhdGUoKSB7XG4gICAgICAgIGdlbmVyYXRpb25zKys7XG4gICAgICAgIHRoaXMuc2V0UG9wdWxhdGlvbihHQS5uZXh0R2VuZXJhdGlvbih0aGlzLnBvcHVsYXRpb24pKTtcbiAgICB9LFxuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICBpZiAoZ2VuZXJhdGlvbnMgJSAxMCA9PT0gMCkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coZ2VuZXJhdGlvbnMgKyAnIGdlcmFjb2VzLCBtZWxob3IgZml0bmVzczogJyArIHRoaXMuYmVzdC5maXRuZXNzKTtcbiAgICAgICAgICAgIHRoaXMudmlldy5yZW5kZXIodGhpcyk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgc2V0UG9wdWxhdGlvbihwb3B1bGF0aW9uKSB7XG4gICAgICAgIHRoaXMucG9wdWxhdGlvbiA9IHBvcHVsYXRpb247XG4gICAgICAgIHRoaXMucG9wdWxhdGlvbi5mb3JFYWNoKHAgPT4gcC5maXRuZXNzID0gdGhpcy5maXRuZXNzRnVuY3Rpb24ocCkpO1xuICAgICAgICB0aGlzLmJlc3QgPSBVdGlscy5tYXhCeShwID0+IHAuZml0bmVzcywgdGhpcy5wb3B1bGF0aW9uKTtcbiAgICB9XG59O1xuXG5sZXQgZ2VuZXJhdGlvbnMgPSAwO1xuXG5jb25zdCBBcHAgPSB7XG4gICAgY3JlYXRlKHZpZXcpIHtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oT2JqZWN0LmNyZWF0ZShwcm90byksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIHt2aWV3OiB2aWV3fSk7XG4gICAgfSxcblxuICAgIFBPUFVMQVRJT05fU0laRTogMjAwXG59O1xuXG5cbmV4cG9ydCB7QXBwfTtcbiIsImNvbnN0IHByb3RvID0ge1xuXG4gICAgaW5pdCgpIHtcbiAgICAgICAgdGhpcy5kb21DYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgICAgICAgdGhpcy5kb21DYW52YXMud2lkdGggPSB0aGlzLndpZHRoO1xuICAgICAgICB0aGlzLmRvbUNhbnZhcy5oZWlnaHQgPSB0aGlzLmhlaWdodDtcbiAgICAgICAgdGhpcy5jdHggPSB0aGlzLmRvbUNhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xuICAgIH0sXG5cbiAgICBzZXRJbWFnZShpbWFnZSkge1xuICAgICAgICB0aGlzLmN0eC5kcmF3SW1hZ2UoaW1hZ2UsIDAsIDApO1xuICAgIH0sXG5cbiAgICBhZGRUbyhkb21Db250YWluZXIpIHtcbiAgICAgICAgZG9tQ29udGFpbmVyLmFwcGVuZENoaWxkKHRoaXMuZG9tQ2FudmFzKTtcbiAgICB9LFxuXG4gICAgZ2V0WXV2SW1hZ2UoKSB7XG4gICAgICAgIGNvbnN0IGltYWdlRGF0YSA9IHRoaXMuY3R4LmdldEltYWdlRGF0YSgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCkuZGF0YSxcbiAgICAgICAgICAgICAgeXV2RGF0YSA9IFtdO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW1hZ2VEYXRhLmxlbmd0aDsgaSArPSA0KSB7XG4gICAgICAgICAgICB5dXZEYXRhLnB1c2goaW1hZ2VEYXRhW2ldKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB5dXZEYXRhO1xuICAgIH0sXG5cbiAgICBzZXRZdXZJbWFnZSh5dXZJbWFnZSkge1xuICAgICAgICBjb25zdCBpbWFnZURhdGEgPSB0aGlzLmN0eC5jcmVhdGVJbWFnZURhdGEodGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpLFxuICAgICAgICAgICAgICBkYXRhID0gaW1hZ2VEYXRhLmRhdGE7XG5cbiAgICAgICAgeXV2SW1hZ2UuZm9yRWFjaChmdW5jdGlvbihjLCBpKXtcbiAgICAgICAgICAgIGNvbnN0IGRhdGFJbmRleCA9IGkqNDtcblxuICAgICAgICAgICAgZGF0YVtkYXRhSW5kZXhdID0gYztcbiAgICAgICAgICAgIGRhdGFbZGF0YUluZGV4KzFdID0gYztcbiAgICAgICAgICAgIGRhdGFbZGF0YUluZGV4KzJdID0gYztcbiAgICAgICAgICAgIGRhdGFbZGF0YUluZGV4KzNdID0gMjU1OyAvLyBhbHBoYVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmN0eC5wdXRJbWFnZURhdGEoaW1hZ2VEYXRhLCAwLCAwKTtcbiAgICB9XG59O1xuXG5jb25zdCBDYW52YXMgPSB7XG4gICAgY3JlYXRlKHdpZHRoLCBoZWlnaHQpIHtcbiAgICAgICAgY29uc3QgY2FudmFzID0gT2JqZWN0LmNyZWF0ZShwcm90byk7XG4gICAgICAgIGNhbnZhcy53aWR0aCA9IHdpZHRoO1xuICAgICAgICBjYW52YXMuaGVpZ2h0ID0gaGVpZ2h0O1xuICAgICAgICBjYW52YXMuaW5pdCgpO1xuXG4gICAgICAgIHJldHVybiBjYW52YXM7XG4gICAgfVxufVxuXG5cbmV4cG9ydCB7Q2FudmFzfTtcbiIsImltcG9ydCB7VXRpbHN9IGZyb20gJy4vdXRpbHMnO1xuXG5jb25zdCBDT05TRVJWRV9SQVRJTyA9IDAuMTtcblxuY29uc3QgR0EgPSB7XG5cbiAgICBuZXh0R2VuZXJhdGlvbihwb3B1bGF0aW9uKSB7XG4gICAgICAgIGNvbnN0IHByZXNlcnZlID0gQ09OU0VSVkVfUkFUSU8gKiBwb3B1bGF0aW9uLmxlbmd0aCxcbiAgICAgICAgICAgICAgc29ydGVkQnlGaXRuZXNzID0gcG9wdWxhdGlvbi5zb3J0KChwMSwgcDIpID0+IHAyLmZpdG5lc3MgLSBwMS5maXRuZXNzKSxcbiAgICAgICAgICAgICAgdG9QcmVzZXJ2ZSA9IHNvcnRlZEJ5Rml0bmVzcy5zbGljZSgwLCBwcmVzZXJ2ZSsxKTtcblxuICAgICAgICBwb3B1bGF0aW9uLnRvdGFsRml0bmVzcyA9IHBvcHVsYXRpb24ucmVkdWNlKChzdW0sIHApID0+IHN1bSArIHAuZml0bmVzcywgMCk7XG4gICAgICAgIHBvcHVsYXRpb24ucHJvYmFiaWxpdGllcyA9IHBvcHVsYXRpb24ubWFwKHAgPT4gcC5maXRuZXNzL3BvcHVsYXRpb24udG90YWxGaXRuZXNzKTtcblxuICAgICAgICByZXR1cm4gVXRpbHMuZmlsbEFycmF5KHBvcHVsYXRpb24ubGVuZ3RoIC0gdG9QcmVzZXJ2ZS5sZW5ndGgsICgpPT4ge1xuICAgICAgICAgICAgbGV0IHAxID0gdGhpcy5zZWxlY3RQYXJlbnQocG9wdWxhdGlvbiksXG4gICAgICAgICAgICAgICAgcDIgPSBwMTtcbiAgICAgICAgICAgIHdoaWxlIChwMiA9PT0gcDEpIHsgcDIgPSB0aGlzLnNlbGVjdFBhcmVudChwb3B1bGF0aW9uKTsgfVxuXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5icmVlZChwMSwgcDIpO1xuICAgICAgICB9KS5jb25jYXQodG9QcmVzZXJ2ZSk7XG4gICAgfSxcblxuICAgIHNlbGVjdFBhcmVudChwb3B1bGF0aW9uKSB7XG4gICAgICAgIGxldCBwYXJlbnRJbmRleCA9IFV0aWxzLmluZGV4QnlQcm9iYWJpbGl0aWVzKHBvcHVsYXRpb24ucHJvYmFiaWxpdGllcyk7XG5cbiAgICAgICAgcmV0dXJuIHBvcHVsYXRpb25bcGFyZW50SW5kZXhdO1xuICAgIH0sXG5cbiAgICBicmVlZChwYXJlbnQxLCBwYXJlbnQyKSB7XG4gICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgMC43NSkge1xuXG4gICAgICAgICAgICBsZXQgY2hpbGQgPSBbXTtcbiAgICAgICAgICAgIC8vIHVuaWZvcm0gY3Jvc3Nzb3ZlcjpcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFyZW50MS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgMC41KSB7XG4gICAgICAgICAgICAgICAgICAgIGNoaWxkLnB1c2gocGFyZW50MVtpXSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY2hpbGQucHVzaChwYXJlbnQyW2ldKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBjaGlsZDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBtdXRhdGUocGFyZW50MSk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgTVVUQVRJT05fUFJPQjogMC4wMDVcbn07XG5cbmZ1bmN0aW9uIG11dGF0ZShnZW5vbWUpIHtcbiAgICBsZXQgbXV0YXRlZCA9IFtdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBnZW5vbWUubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCBHQS5NVVRBVElPTl9QUk9CKSB7XG4gICAgICAgICAgICBtdXRhdGVkLnB1c2goVXRpbHMucmFuZEludCgyNTYpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG11dGF0ZWQucHVzaChnZW5vbWVbaV0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG11dGF0ZWQ7XG59XG5cblxuZXhwb3J0IHtHQX07XG4iLCJpbXBvcnQge1ZpZXd9IGZyb20gJy4vdmlldyc7XG5pbXBvcnQge0FwcH0gZnJvbSAnLi9hcHAnO1xuXG5jb25zdCBwb3B1bGF0aW9uQ29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BvcHVsYXRpb24nKSxcbiAgICAgIHRhcmdldENvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0YXJnZXQnKSxcbiAgICAgIHZpZXcgPSBWaWV3LmNyZWF0ZSh0YXJnZXRDb250YWluZXIsIHBvcHVsYXRpb25Db250YWluZXIpO1xuXG52aWV3LmxvYWQoKCk9PiBBcHAuY3JlYXRlKHZpZXcpLnN0YXJ0KCkpXG4iLCJcbmNvbnN0IFV0aWxzID0ge1xuXG4gICAgcmFuZEludChtYXgpIHtcbiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIG1heCk7XG4gICAgfSxcblxuICAgIHNhbXBsZShhcnJheSkge1xuICAgICAgICBjb25zdCBpbmRleCA9IE1hdGgucmFuZG9tKCkgKiBhcnJheS5sZW5ndGggfCAwO1xuICAgICAgICByZXR1cm4gYXJyYXlbaW5kZXhdO1xuICAgIH0sXG5cbiAgICBmaWxsQXJyYXkoc2l6ZSwgZ2VuZXJhdG9yKSB7XG4gICAgICAgIGNvbnN0IGFycmF5ID0gW107XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspIHtcbiAgICAgICAgICAgIGFycmF5LnB1c2goZ2VuZXJhdG9yKGkpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBhcnJheTtcbiAgICB9LFxuXG4gICAgbWF4QnkodHJhbnNmb3JtLCBpdGVtcykge1xuICAgICAgICByZXR1cm4gaXRlbXMubWFwKGkgPT4gKFxuICAgICAgICAgICAge2l0ZW06IGksIHZhbHVlOiB0cmFuc2Zvcm0oaSl9XG4gICAgICAgICkpLnJlZHVjZSgoYmVzdCwgY3VycmVudCkgPT4gKFxuICAgICAgICAgICAgKGN1cnJlbnQudmFsdWUgPiBiZXN0LnZhbHVlKSA/IGN1cnJlbnQgOiBiZXN0XG4gICAgICAgICkpLml0ZW07XG4gICAgfSxcblxuICAgIGltYWdlRGlmZmVyZW5jZShpbWFnZTEsIGltYWdlMikge1xuICAgICAgICBsZXQgc2NvcmUgPSAwO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW1hZ2UxLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBzY29yZSArPSBNYXRoLnBvdyhpbWFnZTFbaV0gLSBpbWFnZTJbaV0sIDIpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHNjb3JlO1xuICAgIH0sXG5cbiAgICBpbmRleEJ5UHJvYmFiaWxpdGllcyhwcm9icykge1xuICAgICAgICBjb25zdCBwcm9iID0gTWF0aC5yYW5kb20oKTtcbiAgICAgICAgbGV0IGFjY3UgPSBwcm9ic1swXSxcbiAgICAgICAgICAgIGkgPSAwO1xuXG4gICAgICAgIHdoaWxlIChhY2N1IDwgcHJvYikge1xuICAgICAgICAgICAgYWNjdSArPSBwcm9ic1srK2ldO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGk7XG4gICAgfVxufTtcblxuXG5leHBvcnQge1V0aWxzfTtcbiIsImltcG9ydCB7Q2FudmFzfSBmcm9tICcuL2NhbnZhcyc7XG5pbXBvcnQge0FwcH0gZnJvbSAnLi9hcHAnO1xuXG5jb25zdCBpbWFnZV9wYXRoID0gJ2ltYWdlcy9zbWlsZXlfc21hbGwuanBnJztcbmNvbnN0IE5VTUJFUl9PRl9DQU5WQVNFUyA9IDg7XG5cbmNvbnN0IHByb3RvID0ge1xuXG4gICAgbG9hZChjYWxsYmFjaykge1xuICAgICAgICB0aGlzLmltZyA9IG5ldyBJbWFnZSgpO1xuICAgICAgICB0aGlzLmltZy5vbmxvYWQgPSB0aGlzLmxvYWRlZC5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLmZpbmlzaGVkTG9hZGluZ0NhbGxiYWNrID0gY2FsbGJhY2s7XG4gICAgICAgIHRoaXMuaW1nLnNyYyA9IGltYWdlX3BhdGg7XG4gICAgfSxcblxuICAgIHJlbmRlcihhcHApIHtcbiAgICAgICAgdGhpcy5wb3B1bGF0aW9uQ2FudmFzZXMuZm9yRWFjaCgoYywgaSkgPT4gYy5zZXRZdXZJbWFnZShhcHAucG9wdWxhdGlvbltpXSkpO1xuICAgICAgICB0aGlzLmN1cnJlbnRCZXN0Q2FudmFzLnNldFl1dkltYWdlKGFwcC5iZXN0KTtcbiAgICB9LFxuXG4gICAgbG9hZGVkKCkge1xuICAgICAgICB0aGlzLnRhcmdldEltYWdlQ2FudmFzID0gQ2FudmFzLmNyZWF0ZSh0aGlzLmltZy53aWR0aCwgdGhpcy5pbWcuaGVpZ2h0KTtcbiAgICAgICAgdGhpcy50YXJnZXRJbWFnZUNhbnZhcy5zZXRJbWFnZSh0aGlzLmltZyk7XG4gICAgICAgIHRoaXMudGFyZ2V0SW1hZ2VDYW52YXMuYWRkVG8odGhpcy50YXJnZXRDb250YWluZXIpO1xuXG4gICAgICAgIHRoaXMuY3VycmVudEJlc3RDYW52YXMgPSBDYW52YXMuY3JlYXRlKHRoaXMuaW1nLndpZHRoLCB0aGlzLmltZy5oZWlnaHQpO1xuICAgICAgICB0aGlzLmN1cnJlbnRCZXN0Q2FudmFzLmFkZFRvKHRoaXMudGFyZ2V0Q29udGFpbmVyKTtcblxuICAgICAgICB0aGlzLnBvcHVsYXRpb25DYW52YXNlcyA9IFtdO1xuXG4gICAgICAgIGNvbnN0IHRhYmxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGFibGUnKTtcbiAgICAgICAgbGV0IHJvdywgY29sO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgTlVNQkVSX09GX0NBTlZBU0VTOyBpKyspIHtcbiAgICAgICAgICAgIGlmIChpICUgMiA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHJvdyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RyJyk7XG4gICAgICAgICAgICAgICAgdGFibGUuYXBwZW5kQ2hpbGQocm93KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5wb3B1bGF0aW9uQ2FudmFzZXNbaV0gPSBDYW52YXMuY3JlYXRlKHRoaXMuaW1nLndpZHRoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW1nLmhlaWdodCk7XG5cbiAgICAgICAgICAgIGNvbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RkJyk7XG4gICAgICAgICAgICB0aGlzLnBvcHVsYXRpb25DYW52YXNlc1tpXS5hZGRUbyhjb2wpO1xuICAgICAgICAgICAgcm93LmFwcGVuZENoaWxkKGNvbCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnBvcHVsYXRpb25Db250YWluZXIuYXBwZW5kQ2hpbGQodGFibGUpO1xuXG4gICAgICAgIHRoaXMuZmluaXNoZWRMb2FkaW5nQ2FsbGJhY2soKTtcbiAgICB9LFxuXG4gICAgZ2V0VGFyZ2V0SW1hZ2UoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnRhcmdldEltYWdlQ2FudmFzLmdldFl1dkltYWdlKCk7XG4gICAgfVxufTtcblxuY29uc3QgVmlldyA9IHtcbiAgICBjcmVhdGUodGFyZ2V0Q29udGFpbmVyLCBwb3B1bGF0aW9uQ29udGFpbmVyKSB7XG4gICAgICAgIGNvbnN0IHZpZXcgPSBPYmplY3QuYXNzaWduKE9iamVjdC5jcmVhdGUocHJvdG8pLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7dGFyZ2V0Q29udGFpbmVyOiB0YXJnZXRDb250YWluZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3B1bGF0aW9uQ29udGFpbmVyOiBwb3B1bGF0aW9uQ29udGFpbmVyfSk7XG4gICAgICAgIHJldHVybiB2aWV3O1xuICAgIH1cbn07XG5cblxuZXhwb3J0IHtWaWV3fTtcbiJdfQ==
