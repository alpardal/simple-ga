(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
'use strict';

exports.__esModule = true;

var _ga = require('./ga');

var _utils = require('./utils');

var proto = {

    start: function start() {
        var _this = this;

        this.targetImage = this.view.getTargetImage();
        this.fitnessFunction = function (i) {
            return 1 / (1 + _utils.Utils.imageDifference(_this.targetImage, i));
        };
        this.setPopulation(_utils.Utils.fillArray(App.POPULATION_SIZE, function () {
            return _utils.Utils.fillArray(_this.targetImage.length, _utils.Utils.randInt.bind(null, 256));
        }));

        this.render();
        this.run();
    },

    run: function run() {
        this.step();
        requestAnimationFrame(this.run.bind(this));
    },

    step: function step() {
        this.update();
        this.render();
    },

    update: function update() {
        generations++;
        this.setPopulation(_ga.GA.nextGeneration(this.population));
    },

    render: function render() {
        if (generations % 10 === 0) {
            console.log('after ' + generations + ' best is: ' + this.best.fitness);
            this.view.render(this);
        }
    },

    setPopulation: function setPopulation(population) {
        var _this2 = this;

        this.population = population;
        this.population.forEach(function (p) {
            return p.fitness = _this2.fitnessFunction(p);
        });
        this.best = _utils.Utils.maxBy(function (p) {
            return p.fitness;
        }, this.population);
    }
};

var generations = 0;

var App = {
    create: function create(view) {
        return Object.assign(Object.create(proto), { view: view });
    },

    POPULATION_SIZE: 200
};

exports.App = App;

},{"./ga":3,"./utils":5}],2:[function(require,module,exports){
'use strict';

exports.__esModule = true;
var proto = {

    init: function init() {
        this.domCanvas = document.createElement('canvas');
        this.domCanvas.width = this.width;
        this.domCanvas.height = this.height;
        this.ctx = this.domCanvas.getContext('2d');
    },

    setImage: function setImage(image) {
        this.ctx.drawImage(image, 0, 0);
    },

    addTo: function addTo(domContainer) {
        domContainer.appendChild(this.domCanvas);
    },

    getYuvImage: function getYuvImage() {
        var imageData = this.ctx.getImageData(0, 0, this.width, this.height).data,
            yuvData = [];

        for (var i = 0; i < imageData.length; i += 4) {
            yuvData.push(imageData[i]);
        }

        return yuvData;
    },

    setYuvImage: function setYuvImage(yuvImage) {
        var imageData = this.ctx.createImageData(this.width, this.height),
            data = imageData.data;

        yuvImage.forEach(function (c, i) {
            var dataIndex = i * 4;

            data[dataIndex] = c;
            data[dataIndex + 1] = c;
            data[dataIndex + 2] = c;
            data[dataIndex + 3] = 255; // alpha
        });

        this.ctx.putImageData(imageData, 0, 0);
    }
};

var Canvas = {
    create: function create(width, height) {
        var canvas = Object.create(proto);
        canvas.width = width;
        canvas.height = height;
        canvas.init();

        return canvas;
    }
};

exports.Canvas = Canvas;

},{}],3:[function(require,module,exports){
'use strict';

exports.__esModule = true;

var _utils = require('./utils');

var GA = {

    nextGeneration: function nextGeneration(population) {
        var _this = this;

        population.totalFitness = population.reduce(function (sum, p) {
            return sum + p.fitness;
        }, 0);
        population.probabilities = population.map(function (p) {
            return p.fitness / population.totalFitness;
        });

        return _utils.Utils.fillArray(population.length, function () {
            var p1 = _this.selectParent(population),
                p2 = p1;
            while (p2 === p1) {
                p2 = _this.selectParent(population);
            }

            return _this.breed(p1, p2);
        });
    },

    selectParent: function selectParent(population) {
        var parentIndex = _utils.Utils.indexByProbabilities(population.probabilities);

        return population[parentIndex];
    },

    breed: function breed(parent1, parent2) {
        var parents = Math.random() < 0.5 ? [parent1, parent2] : [parent2, parent1],
            crossoverPoint = _utils.Utils.randInt(parents.length - 1),
            child = [];

        for (var i = 0; i < parent1.length; i++) {
            if (i <= crossoverPoint) {
                child.push(parents[0][i]);
            } else {
                child.push(parents[1][i]);
            }

            mutate(child, i);
        }

        return child;
    },

    MUTATION_PROB: 0.0005
};

function mutate(genome, index) {
    if (Math.random() < GA.MUTATION_PROB) {
        genome[index] = _utils.Utils.randInt(256);
    }
}

exports.GA = GA;

},{"./utils":5}],4:[function(require,module,exports){
'use strict';

var _view = require('./view');

var _app = require('./app');

var populationContainer = document.getElementById('population'),
    targetContainer = document.getElementById('target'),
    view = _view.View.create(targetContainer, populationContainer);

view.load(function () {
      return _app.App.create(view).start();
});

},{"./app":1,"./view":6}],5:[function(require,module,exports){
"use strict";

exports.__esModule = true;

var Utils = {

    randInt: function randInt(max) {
        return Math.floor(Math.random() * max);
    },

    sample: function sample(array) {
        var index = Math.random() * array.length | 0;
        return array[index];
    },

    fillArray: function fillArray(size, generator) {
        var array = [];

        for (var i = 0; i < size; i++) {
            array.push(generator(i));
        }

        return array;
    },

    maxBy: function maxBy(transform, items) {
        return items.map(function (i) {
            return { item: i, value: transform(i) };
        }).reduce(function (best, current) {
            return current.value > best.value ? current : best;
        }).item;
    },

    imageDifference: function imageDifference(image1, image2) {
        var score = 0;

        for (var i = 0; i < image1.length; i++) {
            score += Math.pow(image1[i] - image2[i], 2);
        }

        return score;
    },

    indexByProbabilities: function indexByProbabilities(probs) {
        var prob = Math.random();
        var accu = probs[0],
            i = 0;

        while (accu < prob) {
            accu += probs[++i];
        }

        return i;
    }
};

exports.Utils = Utils;

},{}],6:[function(require,module,exports){
'use strict';

exports.__esModule = true;

var _canvas = require('./canvas');

var _app = require('./app');

var image_path = 'images/smiley_small.jpg';
var NUMBER_OF_CANVASES = 4;

var proto = {

    load: function load(callback) {
        this.img = new Image();
        this.img.onload = this.loaded.bind(this);
        this.finishedLoadingCallback = callback;
        this.img.src = image_path;
    },

    render: function render(app) {
        this.populationCanvases.forEach(function (c, i) {
            return c.setYuvImage(app.population[i]);
        });
        this.currentBestCanvas.setYuvImage(app.best);
    },

    loaded: function loaded() {
        this.targetImageCanvas = _canvas.Canvas.create(this.img.width, this.img.height);
        this.targetImageCanvas.setImage(this.img);
        this.targetImageCanvas.addTo(this.targetContainer);

        this.currentBestCanvas = _canvas.Canvas.create(this.img.width, this.img.height);
        this.currentBestCanvas.addTo(this.targetContainer);

        this.populationCanvases = [];

        var table = document.createElement('table');
        var row = undefined,
            col = undefined;

        for (var i = 0; i < NUMBER_OF_CANVASES; i++) {
            if (i % 2 === 0) {
                row = document.createElement('tr');
                table.appendChild(row);
            }

            this.populationCanvases[i] = _canvas.Canvas.create(this.img.width, this.img.height);

            col = document.createElement('td');
            this.populationCanvases[i].addTo(col);
            row.appendChild(col);
        }

        this.populationContainer.appendChild(table);

        this.finishedLoadingCallback();
    },

    getTargetImage: function getTargetImage() {
        return this.targetImageCanvas.getYuvImage();
    }
};

var View = {
    create: function create(targetContainer, populationContainer) {
        var view = Object.assign(Object.create(proto), { targetContainer: targetContainer,
            populationContainer: populationContainer });
        return view;
    }
};

exports.View = View;

},{"./app":1,"./canvas":2}]},{},[1,2,3,4,5,6])
//# sourceMappingURL=data:application/json;charset:utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9ncnVudC1icm93c2VyaWZ5L25vZGVfbW9kdWxlcy9icm93c2VyaWZ5L25vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCIvaG9tZS9hbmRyZS9jb2RlL2dhL2FwcC9hcHAuanMiLCIvaG9tZS9hbmRyZS9jb2RlL2dhL2FwcC9jYW52YXMuanMiLCIvaG9tZS9hbmRyZS9jb2RlL2dhL2FwcC9nYS5qcyIsIi9ob21lL2FuZHJlL2NvZGUvZ2EvYXBwL21haW4uanMiLCIvaG9tZS9hbmRyZS9jb2RlL2dhL2FwcC91dGlscy5qcyIsIi9ob21lL2FuZHJlL2NvZGUvZ2EvYXBwL3ZpZXcuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7O2tCQ0FpQixNQUFNOztxQkFDSCxTQUFTOztBQUU3QixJQUFNLEtBQUssR0FBRzs7QUFFVixTQUFLLEVBQUEsaUJBQUc7OztBQUNKLFlBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztBQUM5QyxZQUFJLENBQUMsZUFBZSxHQUFHLFVBQUMsQ0FBQzttQkFBTSxDQUFDLElBQUUsQ0FBQyxHQUFDLGFBQU0sZUFBZSxDQUFDLE1BQUssV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFBLEFBQUM7U0FBQyxDQUFDO0FBQ2pGLFlBQUksQ0FBQyxhQUFhLENBQUMsYUFBTSxTQUFTLENBQUMsR0FBRyxDQUFDLGVBQWUsRUFDcEQ7bUJBQUssYUFBTSxTQUFTLENBQUMsTUFBSyxXQUFXLENBQUMsTUFBTSxFQUFFLGFBQU0sT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7U0FBQSxDQUFDLENBQUMsQ0FBQzs7QUFFakYsWUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBQ2QsWUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0tBQ2Q7O0FBRUQsT0FBRyxFQUFBLGVBQUc7QUFDRixZQUFJLENBQUMsSUFBSSxFQUFFLENB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dW5jdGlvbiBlKHQsbixyKXtmdW5jdGlvbiBzKG8sdSl7aWYoIW5bb10pe2lmKCF0W29dKXt2YXIgYT10eXBlb2YgcmVxdWlyZT09XCJmdW5jdGlvblwiJiZyZXF1aXJlO2lmKCF1JiZhKXJldHVybiBhKG8sITApO2lmKGkpcmV0dXJuIGkobywhMCk7dmFyIGY9bmV3IEVycm9yKFwiQ2Fubm90IGZpbmQgbW9kdWxlICdcIitvK1wiJ1wiKTt0aHJvdyBmLmNvZGU9XCJNT0RVTEVfTk9UX0ZPVU5EXCIsZn12YXIgbD1uW29dPXtleHBvcnRzOnt9fTt0W29dWzBdLmNhbGwobC5leHBvcnRzLGZ1bmN0aW9uKGUpe3ZhciBuPXRbb11bMV1bZV07cmV0dXJuIHMobj9uOmUpfSxsLGwuZXhwb3J0cyxlLHQsbixyKX1yZXR1cm4gbltvXS5leHBvcnRzfXZhciBpPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7Zm9yKHZhciBvPTA7bzxyLmxlbmd0aDtvKyspcyhyW29dKTtyZXR1cm4gc30pIiwiaW1wb3J0IHtHQX0gZnJvbSAnLi9nYSc7XG5pbXBvcnQge1V0aWxzfSBmcm9tICcuL3V0aWxzJztcblxuY29uc3QgcHJvdG8gPSB7XG5cbiAgICBzdGFydCgpIHtcbiAgICAgICAgdGhpcy50YXJnZXRJbWFnZSA9IHRoaXMudmlldy5nZXRUYXJnZXRJbWFnZSgpO1xuICAgICAgICB0aGlzLmZpdG5lc3NGdW5jdGlvbiA9IChpKSA9PiAoMS8oMStVdGlscy5pbWFnZURpZmZlcmVuY2UodGhpcy50YXJnZXRJbWFnZSwgaSkpKTtcbiAgICAgICAgdGhpcy5zZXRQb3B1bGF0aW9uKFV0aWxzLmZpbGxBcnJheShBcHAuUE9QVUxBVElPTl9TSVpFLFxuICAgICAgICAgICgpPT4gVXRpbHMuZmlsbEFycmF5KHRoaXMudGFyZ2V0SW1hZ2UubGVuZ3RoLCBVdGlscy5yYW5kSW50LmJpbmQobnVsbCwgMjU2KSkpKTtcblxuICAgICAgICB0aGlzLnJlbmRlcigpO1xuICAgICAgICB0aGlzLnJ1bigpO1xuICAgIH0sXG5cbiAgICBydW4oKSB7XG4gICAgICAgIHRoaXMuc3RlcCgpO1xuICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5ydW4uYmluZCh0aGlzKSk7XG4gICAgfSxcblxuICAgIHN0ZXAoKSB7XG4gICAgICAgIHRoaXMudXBkYXRlKCk7XG4gICAgICAgIHRoaXMucmVuZGVyKCk7XG4gICAgfSxcblxuICAgIHVwZGF0ZSgpIHtcbiAgICAgICAgZ2VuZXJhdGlvbnMrKztcbiAgICAgICAgdGhpcy5zZXRQb3B1bGF0aW9uKEdBLm5leHRHZW5lcmF0aW9uKHRoaXMucG9wdWxhdGlvbikpO1xuICAgIH0sXG5cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGlmIChnZW5lcmF0aW9ucyAlIDEwID09PSAwKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnYWZ0ZXIgJyArIGdlbmVyYXRpb25zICsgJyBiZXN0IGlzOiAnICsgdGhpcy5iZXN0LmZpdG5lc3MpO1xuICAgICAgICAgICAgdGhpcy52aWV3LnJlbmRlcih0aGlzKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICBzZXRQb3B1bGF0aW9uKHBvcHVsYXRpb24pIHtcbiAgICAgICAgdGhpcy5wb3B1bGF0aW9uID0gcG9wdWxhdGlvbjtcbiAgICAgICAgdGhpcy5wb3B1bGF0aW9uLmZvckVhY2gocCA9PiBwLmZpdG5lc3MgPSB0aGlzLmZpdG5lc3NGdW5jdGlvbihwKSk7XG4gICAgICAgIHRoaXMuYmVzdCA9IFV0aWxzLm1heEJ5KHAgPT4gcC5maXRuZXNzLCB0aGlzLnBvcHVsYXRpb24pO1xuICAgIH1cbn07XG5cbmxldCBnZW5lcmF0aW9ucyA9IDA7XG5cbmNvbnN0IEFwcCA9IHtcbiAgICBjcmVhdGUodmlldykge1xuICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihPYmplY3QuY3JlYXRlKHByb3RvKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAge3ZpZXc6IHZpZXd9KTtcbiAgICB9LFxuXG4gICAgUE9QVUxBVElPTl9TSVpFOiAyMDBcbn07XG5cblxuZXhwb3J0IHtBcHB9O1xuIiwiY29uc3QgcHJvdG8gPSB7XG5cbiAgICBpbml0KCkge1xuICAgICAgICB0aGlzLmRvbUNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgICAgICB0aGlzLmRvbUNhbnZhcy53aWR0aCA9IHRoaXMud2lkdGg7XG4gICAgICAgIHRoaXMuZG9tQ2FudmFzLmhlaWdodCA9IHRoaXMuaGVpZ2h0O1xuICAgICAgICB0aGlzLmN0eCA9IHRoaXMuZG9tQ2FudmFzLmdldENvbnRleHQoJzJkJyk7XG4gICAgfSxcblxuICAgIHNldEltYWdlKGltYWdlKSB7XG4gICAgICAgIHRoaXMuY3R4LmRyYXdJbWFnZShpbWFnZSwgMCwgMCk7XG4gICAgfSxcblxuICAgIGFkZFRvKGRvbUNvbnRhaW5lcikge1xuICAgICAgICBkb21Db250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5kb21DYW52YXMpO1xuICAgIH0sXG5cbiAgICBnZXRZdXZJbWFnZSgpIHtcbiAgICAgICAgY29uc3QgaW1hZ2VEYXRhID0gdGhpcy5jdHguZ2V0SW1hZ2VEYXRhKDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KS5kYXRhLFxuICAgICAgICAgICAgICB5dXZEYXRhID0gW107XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbWFnZURhdGEubGVuZ3RoOyBpICs9IDQpIHtcbiAgICAgICAgICAgIHl1dkRhdGEucHVzaChpbWFnZURhdGFbaV0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHl1dkRhdGE7XG4gICAgfSxcblxuICAgIHNldFl1dkltYWdlKHl1dkltYWdlKSB7XG4gICAgICAgIGNvbnN0IGltYWdlRGF0YSA9IHRoaXMuY3R4LmNyZWF0ZUltYWdlRGF0YSh0aGlzLndpZHRoLCB0aGlzLmhlaWdodCksXG4gICAgICAgICAgICAgIGRhdGEgPSBpbWFnZURhdGEuZGF0YTtcblxuICAgICAgICB5dXZJbWFnZS5mb3JFYWNoKGZ1bmN0aW9uKGMsIGkpe1xuICAgICAgICAgICAgY29uc3QgZGF0YUluZGV4ID0gaSo0O1xuXG4gICAgICAgICAgICBkYXRhW2RhdGFJbmRleF0gPSBjO1xuICAgICAgICAgICAgZGF0YVtkYXRhSW5kZXgrMV0gPSBjO1xuICAgICAgICAgICAgZGF0YVtkYXRhSW5kZXgrMl0gPSBjO1xuICAgICAgICAgICAgZGF0YVtkYXRhSW5kZXgrM10gPSAyNTU7IC8vIGFscGhhXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuY3R4LnB1dEltYWdlRGF0YShpbWFnZURhdGEsIDAsIDApO1xuICAgIH1cbn07XG5cbmNvbnN0IENhbnZhcyA9IHtcbiAgICBjcmVhdGUod2lkdGgsIGhlaWdodCkge1xuICAgICAgICBjb25zdCBjYW52YXMgPSBPYmplY3QuY3JlYXRlKHByb3RvKTtcbiAgICAgICAgY2FudmFzLndpZHRoID0gd2lkdGg7XG4gICAgICAgIGNhbnZhcy5oZWlnaHQgPSBoZWlnaHQ7XG4gICAgICAgIGNhbnZhcy5pbml0KCk7XG5cbiAgICAgICAgcmV0dXJuIGNhbnZhcztcbiAgICB9XG59XG5cblxuZXhwb3J0IHtDYW52YXN9O1xuIiwiaW1wb3J0IHtVdGlsc30gZnJvbSAnLi91dGlscyc7XG5cbmNvbnN0IEdBID0ge1xuXG4gICAgbmV4dEdlbmVyYXRpb24ocG9wdWxhdGlvbikge1xuICAgICAgICBwb3B1bGF0aW9uLnRvdGFsRml0bmVzcyA9IHBvcHVsYXRpb24ucmVkdWNlKChzdW0sIHApID0+IHN1bSArIHAuZml0bmVzcywgMCk7XG4gICAgICAgIHBvcHVsYXRpb24ucHJvYmFiaWxpdGllcyA9IHBvcHVsYXRpb24ubWFwKHAgPT4gcC5maXRuZXNzL3BvcHVsYXRpb24udG90YWxGaXRuZXNzKTtcblxuICAgICAgICByZXR1cm4gVXRpbHMuZmlsbEFycmF5KHBvcHVsYXRpb24ubGVuZ3RoLCAoKT0+IHtcbiAgICAgICAgICAgIGxldCBwMSA9IHRoaXMuc2VsZWN0UGFyZW50KHBvcHVsYXRpb24pLFxuICAgICAgICAgICAgICAgIHAyID0gcDE7XG4gICAgICAgICAgICB3aGlsZSAocDIgPT09IHAxKSB7IHAyID0gdGhpcy5zZWxlY3RQYXJlbnQocG9wdWxhdGlvbik7IH1cblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYnJlZWQocDEsIHAyKTtcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIHNlbGVjdFBhcmVudChwb3B1bGF0aW9uKSB7XG4gICAgICAgIGxldCBwYXJlbnRJbmRleCA9IFV0aWxzLmluZGV4QnlQcm9iYWJpbGl0aWVzKHBvcHVsYXRpb24ucHJvYmFiaWxpdGllcyk7XG5cbiAgICAgICAgcmV0dXJuIHBvcHVsYXRpb25bcGFyZW50SW5kZXhdO1xuICAgIH0sXG5cbiAgICBicmVlZChwYXJlbnQxLCBwYXJlbnQyKSB7XG4gICAgICAgIGxldCBwYXJlbnRzID0gKE1hdGgucmFuZG9tKCkgPCAwLjUpID8gW3BhcmVudDEsIHBhcmVudDJdIDogW3BhcmVudDIsIHBhcmVudDFdLFxuICAgICAgICAgICAgY3Jvc3NvdmVyUG9pbnQgPSBVdGlscy5yYW5kSW50KHBhcmVudHMubGVuZ3RoLTEpLFxuICAgICAgICAgICAgY2hpbGQgPSBbXTtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhcmVudDEubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGlmIChpIDw9IGNyb3Nzb3ZlclBvaW50KSB7XG4gICAgICAgICAgICAgICAgY2hpbGQucHVzaChwYXJlbnRzWzBdW2ldKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY2hpbGQucHVzaChwYXJlbnRzWzFdW2ldKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICBtdXRhdGUoY2hpbGQsIGkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNoaWxkO1xuICAgIH0sXG5cbiAgICBNVVRBVElPTl9QUk9COiAwLjAwMDVcbn07XG5cbmZ1bmN0aW9uIG11dGF0ZShnZW5vbWUsIGluZGV4KSB7XG4gICAgaWYgKE1hdGgucmFuZG9tKCkgPCBHQS5NVVRBVElPTl9QUk9CKSB7XG4gICAgICAgIGdlbm9tZVtpbmRleF0gPSBVdGlscy5yYW5kSW50KDI1Nik7XG4gICAgfVxufVxuXG5cbmV4cG9ydCB7R0F9O1xuIiwiaW1wb3J0IHtWaWV3fSBmcm9tICcuL3ZpZXcnO1xuaW1wb3J0IHtBcHB9IGZyb20gJy4vYXBwJztcblxuY29uc3QgcG9wdWxhdGlvbkNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwb3B1bGF0aW9uJyksXG4gICAgICB0YXJnZXRDb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGFyZ2V0JyksXG4gICAgICB2aWV3ID0gVmlldy5jcmVhdGUodGFyZ2V0Q29udGFpbmVyLCBwb3B1bGF0aW9uQ29udGFpbmVyKTtcblxudmlldy5sb2FkKCgpPT4gQXBwLmNyZWF0ZSh2aWV3KS5zdGFydCgpKVxuIiwiXG5jb25zdCBVdGlscyA9IHtcblxuICAgIHJhbmRJbnQobWF4KSB7XG4gICAgICAgIHJldHVybiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBtYXgpO1xuICAgIH0sXG5cbiAgICBzYW1wbGUoYXJyYXkpIHtcbiAgICAgICAgY29uc3QgaW5kZXggPSBNYXRoLnJhbmRvbSgpICogYXJyYXkubGVuZ3RoIHwgMDtcbiAgICAgICAgcmV0dXJuIGFycmF5W2luZGV4XTtcbiAgICB9LFxuXG4gICAgZmlsbEFycmF5KHNpemUsIGdlbmVyYXRvcikge1xuICAgICAgICBjb25zdCBhcnJheSA9IFtdO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7XG4gICAgICAgICAgICBhcnJheS5wdXNoKGdlbmVyYXRvcihpKSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYXJyYXk7XG4gICAgfSxcblxuICAgIG1heEJ5KHRyYW5zZm9ybSwgaXRlbXMpIHtcbiAgICAgICAgcmV0dXJuIGl0ZW1zLm1hcChpID0+IChcbiAgICAgICAgICAgIHtpdGVtOiBpLCB2YWx1ZTogdHJhbnNmb3JtKGkpfVxuICAgICAgICApKS5yZWR1Y2UoKGJlc3QsIGN1cnJlbnQpID0+IChcbiAgICAgICAgICAgIChjdXJyZW50LnZhbHVlID4gYmVzdC52YWx1ZSkgPyBjdXJyZW50IDogYmVzdFxuICAgICAgICApKS5pdGVtO1xuICAgIH0sXG5cbiAgICBpbWFnZURpZmZlcmVuY2UoaW1hZ2UxLCBpbWFnZTIpIHtcbiAgICAgICAgbGV0IHNjb3JlID0gMDtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGltYWdlMS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgc2NvcmUgKz0gTWF0aC5wb3coaW1hZ2UxW2ldIC0gaW1hZ2UyW2ldLCAyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBzY29yZTtcbiAgICB9LFxuXG4gICAgaW5kZXhCeVByb2JhYmlsaXRpZXMocHJvYnMpIHtcbiAgICAgICAgY29uc3QgcHJvYiA9IE1hdGgucmFuZG9tKCk7XG4gICAgICAgIGxldCBhY2N1ID0gcHJvYnNbMF0sXG4gICAgICAgICAgICBpID0gMDtcblxuICAgICAgICB3aGlsZSAoYWNjdSA8IHByb2IpIHtcbiAgICAgICAgICAgIGFjY3UgKz0gcHJvYnNbKytpXTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBpO1xuICAgIH1cbn07XG5cblxuZXhwb3J0IHtVdGlsc307XG4iLCJpbXBvcnQge0NhbnZhc30gZnJvbSAnLi9jYW52YXMnO1xuaW1wb3J0IHtBcHB9IGZyb20gJy4vYXBwJztcblxuY29uc3QgaW1hZ2VfcGF0aCA9ICdpbWFnZXMvc21pbGV5X3NtYWxsLmpwZyc7XG5jb25zdCBOVU1CRVJfT0ZfQ0FOVkFTRVMgPSA0O1xuXG5jb25zdCBwcm90byA9IHtcblxuICAgIGxvYWQoY2FsbGJhY2spIHtcbiAgICAgICAgdGhpcy5pbWcgPSBuZXcgSW1hZ2UoKTtcbiAgICAgICAgdGhpcy5pbWcub25sb2FkID0gdGhpcy5sb2FkZWQuYmluZCh0aGlzKTtcbiAgICAgICAgdGhpcy5maW5pc2hlZExvYWRpbmdDYWxsYmFjayA9IGNhbGxiYWNrO1xuICAgICAgICB0aGlzLmltZy5zcmMgPSBpbWFnZV9wYXRoO1xuICAgIH0sXG5cbiAgICByZW5kZXIoYXBwKSB7XG4gICAgICAgIHRoaXMucG9wdWxhdGlvbkNhbnZhc2VzLmZvckVhY2goKGMsIGkpID0+IGMuc2V0WXV2SW1hZ2UoYXBwLnBvcHVsYXRpb25baV0pKTtcbiAgICAgICAgdGhpcy5jdXJyZW50QmVzdENhbnZhcy5zZXRZdXZJbWFnZShhcHAuYmVzdCk7XG4gICAgfSxcblxuICAgIGxvYWRlZCgpIHtcbiAgICAgICAgdGhpcy50YXJnZXRJbWFnZUNhbnZhcyA9IENhbnZhcy5jcmVhdGUodGhpcy5pbWcud2lkdGgsIHRoaXMuaW1nLmhlaWdodCk7XG4gICAgICAgIHRoaXMudGFyZ2V0SW1hZ2VDYW52YXMuc2V0SW1hZ2UodGhpcy5pbWcpO1xuICAgICAgICB0aGlzLnRhcmdldEltYWdlQ2FudmFzLmFkZFRvKHRoaXMudGFyZ2V0Q29udGFpbmVyKTtcblxuICAgICAgICB0aGlzLmN1cnJlbnRCZXN0Q2FudmFzID0gQ2FudmFzLmNyZWF0ZSh0aGlzLmltZy53aWR0aCwgdGhpcy5pbWcuaGVpZ2h0KTtcbiAgICAgICAgdGhpcy5jdXJyZW50QmVzdENhbnZhcy5hZGRUbyh0aGlzLnRhcmdldENvbnRhaW5lcik7XG5cbiAgICAgICAgdGhpcy5wb3B1bGF0aW9uQ2FudmFzZXMgPSBbXTtcblxuICAgICAgICBjb25zdCB0YWJsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RhYmxlJyk7XG4gICAgICAgIGxldCByb3csIGNvbDtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IE5VTUJFUl9PRl9DQU5WQVNFUzsgaSsrKSB7XG4gICAgICAgICAgICBpZiAoaSAlIDIgPT09IDApIHtcbiAgICAgICAgICAgICAgICByb3cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpO1xuICAgICAgICAgICAgICAgIHRhYmxlLmFwcGVuZENoaWxkKHJvdyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMucG9wdWxhdGlvbkNhbnZhc2VzW2ldID0gQ2FudmFzLmNyZWF0ZSh0aGlzLmltZy53aWR0aCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmltZy5oZWlnaHQpO1xuXG4gICAgICAgICAgICBjb2wgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZCcpO1xuICAgICAgICAgICAgdGhpcy5wb3B1bGF0aW9uQ2FudmFzZXNbaV0uYWRkVG8oY29sKTtcbiAgICAgICAgICAgIHJvdy5hcHBlbmRDaGlsZChjb2wpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5wb3B1bGF0aW9uQ29udGFpbmVyLmFwcGVuZENoaWxkKHRhYmxlKTtcblxuICAgICAgICB0aGlzLmZpbmlzaGVkTG9hZGluZ0NhbGxiYWNrKCk7XG4gICAgfSxcblxuICAgIGdldFRhcmdldEltYWdlKCkge1xuICAgICAgICByZXR1cm4gdGhpcy50YXJnZXRJbWFnZUNhbnZhcy5nZXRZdXZJbWFnZSgpO1xuICAgIH1cbn07XG5cbmNvbnN0IFZpZXcgPSB7XG4gICAgY3JlYXRlKHRhcmdldENvbnRhaW5lciwgcG9wdWxhdGlvbkNvbnRhaW5lcikge1xuICAgICAgICBjb25zdCB2aWV3ID0gT2JqZWN0LmFzc2lnbihPYmplY3QuY3JlYXRlKHByb3RvKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAge3RhcmdldENvbnRhaW5lcjogdGFyZ2V0Q29udGFpbmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9wdWxhdGlvbkNvbnRhaW5lcjogcG9wdWxhdGlvbkNvbnRhaW5lcn0pO1xuICAgICAgICByZXR1cm4gdmlldztcbiAgICB9XG59O1xuXG5cbmV4cG9ydCB7Vmlld307XG4iXX0=
